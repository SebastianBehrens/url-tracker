{% extends "base.html" %}

{% block content %}
<div class="flex flex-col h-screen bg-base-100">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <header class="bg-base-100 shadow-sm z-50">
        <div class="container mx-auto px-6 max-w-[1920px]">
            <div class="navbar bg-base-100 px-0">
                <div class="navbar-start">
                    <a href="/" class="btn btn-ghost text-primary hover:text-primary-focus text-2xl font-bold normal-case">
                        URL Tracker
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col items-center justify-center p-6 overflow-hidden">

        <div class="flex items-center w-full max-w-[min(80vw,500px)] mb-6">
            <div class="card bg-base-200 shadow-md w-full p-4">
                <div class="flex items-center gap-3">
                    <button class="btn btn-primary btn-outline rounded-lg hover:bg-primary hover:text-primary-content transition-all duration-200" 
                            onclick="window.modal_explanation.showModal()"
                            title="What is this?">
                        <span class="material-symbols-rounded">info</span>
                    </button>
                    <select class="select select-bordered w-full"
                            name="url"
                            onchange="handleUrlSelection(this.value)">
                        <option disabled selected>Choose a URL</option>
                        {% for url in urls %}
                        <option value="{{ url }}">{{ url }}</option>
                        {% endfor %}
                    </select>
                    <button class="btn btn-primary btn-outline rounded-lg hover:bg-primary hover:text-primary-content transition-all duration-200" 
                            onclick="window.modal_timeline.showModal()"
                            title="View Timeline">
                        <span class="material-symbols-rounded">data_array</span>
                    </button>
                </div>
            </div>
        </div>

        <dialog id="modal_explanation" class="modal">
            <div class="modal-box prose max-h-[60vh] overflow-y-auto">
                <div class="text-base">
                    <h3 class="font-bold text-lg mb-4">What is this?</h3>
                  
                    <p class="mb-4">
                      Hi there,
                    </p>
                    <p class="mb-4">
                        This is my personal URL Tracker. I love to know things and am also a bit of an archivist. So in this case, I archive the
                        (<span class="tooltip tooltip-left cursor-help underline decoration-dotted" data-tip="The general geographical region or country where a website's servers are located. This is not precise to a street address or specific data center.">
                          general
                        </span>)
                        hosting locations of some websites.
                      </p>                  
                    <p class="mb-4">
                      Popular websites (like google.com) use load balancers to redirect internet traffic to different servers, and/or use different servers depending on the region (why fly to a city to shop if you can go downtown).
                    </p>
                  
                    <p>
                      Most pages, however, don't do that. This application is made for those. Enjoy.
                    </p>

                    <div class="divider"></div>
                    <div class="flex justify-between items-center px-4">
                        <p class="text-base-content/60">
                            Made by <a href="https://epsian.ch" class="link link-primary">me.</a>
                        </p>
                        <form method="dialog">
                            <button class="btn">Close</button>
                        </form>
                    </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <dialog id="modal_timeline" class="modal">
            <div class="modal-box max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Location Timeline</h3>
                <div id="timeline-container" class="min-h-[200px] overflow-y-auto max-h-[60vh] pr-20">
                    <!-- Timeline will be loaded here -->
                </div>
                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn">Close</button>
                    </form>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <div class="relative flex-1 w-full max-w-[80vw] h-[50vh] card bg-base-200 shadow-xl p-0">
            <div id="map-container" class="absolute inset-0">
                {% include 'map-trace.html' %}
            </div>
        </div>

    </main>

    <footer class="footer footer-center p-4 text-base-content/60 bg-base-100 border-t border-base-200 z-40">
        <div class="container mx-auto px-6 w-full">
            <p>¬© 2025 URL Tracker. All rights reserved. Made by <a href="https://epsian.ch/" class="link link-primary">me</a>.</p>
        </div>
    </footer>

</div>

<script>
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function renderTimeline(locations) {
        if (!locations || locations.length === 0) {
            return `
                <div class="text-center text-base-content/60 py-8">
                    <div class="text-4xl mb-4">üìç</div>
                    <div>No location data available</div>
                </div>
            `;
        }

        return `
    <ul class="timeline timeline-vertical">
        ${locations.map((location, index) => {
            const [detected_at, lat, lon, country, city, isp] = location;
            return `
                <li>
                    ${index > 0 ? '<hr/>' : ''}
                    <div class="timeline-start">${formatDate(detected_at)}</div>
                    <div class="timeline-middle">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g id="SVGRepo_bgCarrier" stroke-width="0"></g><g id="SVGRepo_tracerCarrier" stroke-linecap="round" stroke-linejoin="round"></g><g id="SVGRepo_iconCarrier"> <path d="M12 21C15.5 17.4 19 14.1764 19 10.2C19 6.22355 15.866 3 12 3C8.13401 3 5 6.22355 5 10.2C5 14.1764 8.5 17.4 12 21Z" stroke="#000000" stroke-width="2.75" stroke-linecap="round" stroke-linejoin="round"></path> </g></svg>
                    </div>
                    <div class="timeline-end timeline-box" style="width: 100%; max-width: 300px; word-break: break-word; white-space: normal;">
                        ${city || 'Unknown City'}, ${country || 'Unknown Country'}<br>
                        (${lat}, ${lon})
                        <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" class="link link-primary ml-1">
                            <span class="material-symbols-rounded" style="font-size: 1em; vertical-align: middle;">map</span>
                        </a>
                    </div>
                    ${index < locations.length - 1 ? '<hr/>' : ''}
                </li>
            `;
        }).join('')}
    </ul>`;
    }

    async function handleUrlSelection(selectedUrl) {
        if (!selectedUrl) return;

        const apiUrl = `/api/locations/${encodeURIComponent(selectedUrl)}`;
        try {
            const response = await fetch(apiUrl, {
                credentials: 'include'  // Important: Send cookies with request
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const locations = await response.json();
            
            // Update map (existing functionality)
            if (window.updateMap) {
                window.updateMap(locations);
            }
            
            // Update timeline content immediately
            const container = document.getElementById('timeline-container');
            container.innerHTML = renderTimeline(locations);
            
        } catch (error) {
            console.error('Failed to fetch location data:', error);
            if (window.updateMap) {
                window.updateMap([]);
            }
            const container = document.getElementById('timeline-container');
            container.innerHTML = '<div class="text-error text-center py-4">Failed to load location data</div>';
        }
    }
</script>
{% endblock %}