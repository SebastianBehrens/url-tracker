{% extends "base.html" %}

{% block content %}
<div class="flex flex-col h-screen bg-base-100">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />

    <header class="bg-base-100 shadow-sm z-50">
        <div class="container mx-auto px-6 max-w-[1920px]">
            <div class="navbar bg-base-100 px-0">
                <div class="navbar-start">
                    <a href="/" class="btn btn-ghost text-primary hover:text-primary-focus text-2xl font-bold normal-case">
                        URL Tracker
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="flex-1 flex flex-col items-center justify-center p-6 overflow-hidden">

        <div class="flex items-center w-full max-w-lg mb-6">
            <div class="w-[15%] flex justify-center">
                <button class="btn btn-sm btn-circle btn-ghost" onclick="window.modal_explanation.showModal()">?</button>
            </div>
            <div class="w-[85%]">
                <div class="card bg-base-200 shadow-md w-full p-4">
                    <div class="flex items-center gap-2">
                        <select class="select select-bordered w-full"
                                name="url"
                                onchange="handleUrlSelection(this.value)">
                            <option disabled selected>Choose a URL</option>
                            {% for url in urls %}
                            <option value="{{ url }}">{{ url }}</option>
                            {% endfor %}
                        </select>
                        <button class="btn btn-sm btn-ghost" onclick="window.modal_timeline.showModal()">
                            <span class="material-symbols-rounded">data_array</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <dialog id="modal_explanation" class="modal">
            <div class="modal-box prose max-h-[60vh] overflow-y-auto">
                <div class="text-base">
                    <h3 class="font-bold text-lg mb-4">What is this?</h3>
                  
                    <p class="mb-4">
                      Hi there,
                    </p>
                    <p class="mb-4">
                        This is my personal URL Tracker. I love to know things and am also a bit of an archivist. So in this case, I archive the
                        (<span class="tooltip tooltip-left cursor-help underline decoration-dotted" data-tip="The general geographical region or country where a website's servers are located. This is not precise to a street address or specific data center.">
                          general
                        </span>)
                        hosting locations of some websites.
                      </p>                  
                    <p class="mb-4">
                      Popular websites (like google.com) use load balancers to redirect internet traffic to different servers, and/or use different servers depending on the region (why fly to a city to shop if you can go downtown).
                    </p>
                  
                    <p>
                      Most pages, however, don't do that. This application is made for those. Enjoy.
                    </p>

                    <div class="divider"></div>
                    <div class="flex justify-between items-center px-4">
                        <p class="text-base-content/60">
                            Made by <a href="https://epsian.ch" class="link link-primary">me.</a>
                        </p>
                        <form method="dialog">
                            <button class="btn">Close</button>
                        </form>
                    </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <dialog id="modal_timeline" class="modal">
            <div class="modal-box max-w-2xl">
                <h3 class="font-bold text-lg mb-4">Location Timeline</h3>
                <div id="timeline-container" class="min-h-[200px] overflow-y-auto max-h-[60vh] pr-20">
                    <!-- Timeline will be loaded here -->
                </div>
                <div class="modal-action">
                    <form method="dialog">
                        <button class="btn">Close</button>
                    </form>
                </div>
            </div>
            <form method="dialog" class="modal-backdrop">
                <button>close</button>
            </form>
        </dialog>

        <div class="relative flex-1 w-full max-w-[80vw] h-[50vh] card bg-base-200 shadow-xl p-0">
            <div id="map-container" class="absolute inset-0">
                {% include 'map-trace.html' %}
            </div>
        </div>

    </main>

    <footer class="footer footer-center p-4 text-base-content/60 bg-base-100 border-t border-base-200 z-40">
        <div class="container mx-auto px-6 w-full">
            <p>¬© 2025 URL Tracker. All rights reserved. Made by <a href="https://epsian.ch/" class="link link-primary">me</a>.</p>
        </div>
    </footer>

</div>

<script>
    function formatDate(dateString) {
        return new Date(dateString).toLocaleDateString(undefined, {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    function renderTimeline(locations) {
        if (!locations || locations.length === 0) {
            return `
                <div class="text-center text-base-content/60 py-8">
                    <div class="text-4xl mb-4">üìç</div>
                    <div>No location data available</div>
                </div>
            `;
        }

        return `
    <ul class="timeline timeline-vertical">
        ${locations.map((location, index) => {
            const [detected_at, lat, lon, country, city, isp] = location;
            return `
                <li>
                    ${index > 0 ? '<hr/>' : ''}
                    <div class="timeline-start">${formatDate(detected_at)}</div>
                    <div class="timeline-middle">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                        </svg>
                    </div>
                    <div class="timeline-end timeline-box" style="width: 100%; max-width: 300px; word-break: break-word; white-space: normal;">
                        ${city || 'Unknown City'}, ${country || 'Unknown Country'}<br>
                        (${lat}, ${lon})
                        <a href="https://www.google.com/maps?q=${lat},${lon}" target="_blank" class="link link-primary ml-1">
                            <span class="material-symbols-rounded" style="font-size: 1em; vertical-align: middle;">map</span>
                        </a>
                    </div>
                    ${index < locations.length - 1 ? '<hr/>' : ''}
                </li>
            `;
        }).join('')}
    </ul>`;
    }

    async function handleUrlSelection(selectedUrl) {
        if (!selectedUrl) return;

        const apiUrl = `/api/locations/${encodeURIComponent(selectedUrl)}`;
        try {
            const response = await fetch(apiUrl, {
                credentials: 'include'  // Important: Send cookies with request
            });
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const locations = await response.json();
            
            // Update map (existing functionality)
            if (window.updateMap) {
                window.updateMap(locations);
            }
            
            // Update timeline content immediately
            const container = document.getElementById('timeline-container');
            container.innerHTML = renderTimeline(locations);
            
        } catch (error) {
            console.error('Failed to fetch location data:', error);
            if (window.updateMap) {
                window.updateMap([]);
            }
            const container = document.getElementById('timeline-container');
            container.innerHTML = '<div class="text-error text-center py-4">Failed to load location data</div>';
        }
    }
</script>
{% endblock %}